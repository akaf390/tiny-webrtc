var WebRTC=function(e){"use strict";function n(e,n,o){"error"==e&&console.error(n);for(var t in L[e])L[e].hasOwnProperty(t)&&"function"==typeof L[e][t]&&L[e][t](n,o)}function o(e){var n=new RegExp(e+"=(.+?)(&|$)").exec(location[T.roomParamType]);return n?decodeURI(n[1]):n}function t(){p=new WebSocket(T.wsServer),setTimeout(function(){R||n("error","connecting to websocket server failed")},5e3),p.onopen=function(){R=!0;var e=o(T.roomParamName);e&&(T.room=e)},p.onmessage=function(e){e=JSON.parse(e.data),"function"==typeof S[e.fn]&&S[e.fn](e.data)},p.onerror=function(e){n("error",e.data)}}function r(e,n){p.send(JSON.stringify({fn:e,data:n}))}function a(){p?null!==T.room&&r("joinRoom",{room:T.room}):I=!0}function i(e){h[e]&&(delete h[e],n("userLeave",e))}function c(e){for(var n in e)e.hasOwnProperty(n)&&s(e[n])}function s(e){m(e),h[e].createOffer(function(n){r("offer",{userId:e,offer:n}),h[e].setLocalDescription(n)},null,T.mediaConstraints)}function d(){return Math.floor(999999*Math.random())}function u(){window.navigator.getUserMedia=window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||window.navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.AudioContext=window.AudioContext||window.webkitAudioContext,window.RTCPeerConnection=window.webkitRTCPeerConnection||window.mozRTCPeerConnection}function f(e){if(navigator.getUserMedia){var o={video:!0,audio:!0};navigator.getUserMedia(o,e,function(){n("error","An Error occured while accessing your camera and microphone. Please reload this page")})}else n("error","no getUserMedia support on your browser :(")}function m(e){var o=new RTCPeerConnection({iceServers:T.iceServers},T.mediaConstraints);o=new RTCPeerConnection({iceServers:T.iceServers},T.mediaConstraints),o.onicecandidate=function(n){n.candidate&&r("iceCandidate",{iceCandidate:{type:"candidate",label:n.candidate.sdpMLineIndex,id:n.candidate.sdpMid,candidate:n.candidate.candidate},userId:e})},o.onconnecting=function(){},o.onopen=function(){},o.onaddstream=function(t){o.streamURL=w(t.stream),o.stream=t.stream,n("userConnect",e)},o.onremovestream=function(){i(e)},o.ondatachannel=function(e){var n=e.channel;n.onmessage=function(){}},o.addStream(v),o.streamURL="",o.stream="",o.RTCDataChannel=o.createDataChannel("RTCDataChannel",{reliable:!1}),o.RTCDataChannel.onmessage=function(o){var t=decodeURI(o.data);try{t=JSON.parse(t)}catch(r){}n("data",e,t)},h[e]=o}function w(e){var n;try{n=window.URL.createObjectURL(e)||e}catch(o){n=e}return n}var l,C,v,p,R=!1,h={},g=!1,I=!1,y=this,U=!1,L={load:[],init:[],scriptLoaded:[],cameraAccess:[],connect:[],roomJoin:[],userConnect:[],userLeave:[],data:[],error:[]},T={wsServer:"ws://tiny-webrtc-server2.nodejitsu.com/",iceServers:[{url:"stun:stun.l.google.com:19302"}],mediaConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{RtpDataChannels:!0}]},roomParamType:"hash",roomParamName:"r",autoInit:!0,autoJoinRoom:!0,room:d()},S={userId:function(e){C=e.userId,n("connect",C),(T.autoJoinRoom||I)&&a()},offer:function(e){m(e.userId),h[e.userId].setRemoteDescription(new RTCSessionDescription(e.offer)),h[e.userId].createAnswer(function(n){h[e.userId].setLocalDescription(n),r("answer",{userId:e.userId,answer:n})},null,T.mediaConstraints)},answer:function(e){h[e.userId].setRemoteDescription(new RTCSessionDescription(e.answer))},iceCandidate:function(e){h[e.userId].addIceCandidate(new RTCIceCandidate({sdpMLineIndex:e.iceCandidate.label,candidate:e.iceCandidate.candidate}))},userLeave:function(e){i(e.userId)},roomJoinSuccess:function(e){0!=e.users.length&&c(e.users),n("roomJoin",T.room)},roomJoinError:function(e){"room full"==e?n("error","room limit reached"):n("error","joining room on server failed")}};y.init=function(){U||(U=!0,n("init"),u(),f(function(e){g=!0,l=w(e),v=e,n("cameraAccess",l),t()}))},y.onLoad=function(e){L.load.push(e)},y.onInit=function(e){L.init.push(e)},y.onCameraAccess=function(e){L.cameraAccess.push(e)},y.onConnect=function(e){L.connect.push(e)},y.onRoomJoin=function(e){L.roomJoin.push(e)},y.onUserConnect=function(e){L.userConnect.push(e)},y.onUserLeave=function(e){L.userLeave.push(e)},y.onData=function(e){L.data.push(e)},y.onError=function(e){L.error.push(e)},y.getRemoteStream=function(e){return h[e]?h[e].streamURL:""},y.getLocalStream=function(){return l},y.joinRoom=function(e){null!==T.room?(y.leaveRoom(),T.room=e,a()):(T.room=e,a())},y.leaveRoom=function(){for(var e in h)h.hasOwnProperty(e)&&h[e].stream.stop();p?r("leaveRoom"):T.room=null},y.getRoom=function(){return T.room},y.sendData=function(e,n){var o=h[e];if(o)if("open"==o.RTCDataChannel.readyState){"object"==typeof n&&(n=JSON.stringify(n)),n=encodeURI(n);try{o.RTCDataChannel.send(n)}catch(t){console.warn(t.message)}}else setTimeout(function(){y.sendData(e,n)},100)},y.sendDataAll=function(e){for(var n in h)h.hasOwnProperty(n)&&y.sendData(n,e)},y.getMyId=function(){return C},y.setConfig=function(e){if("object"==typeof e&&null!==e)for(var n in T)T.hasOwnProperty(n)&&void 0!==e[n]&&(T[n]=e[n])},y.setConfig(e),setTimeout(function(){n("load")},0),T.autoInit&&setTimeout(function(){y.init()},0)};